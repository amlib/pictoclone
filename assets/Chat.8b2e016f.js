import{_ as $,W as F,c as j,a as V,b as G,r as K,h as z,g as Q,M as J,K as Z,d as ee,e as te,f as oe}from"./index.3fc933d0.js";import{r as p,o as m,h as k,w as x,j as se,a as C,n as y,d as q,f as g,e as d,t as E,g as _,b as D,l as A,F as H,m as U,z as Y,q as ie,x as ne,y as ae}from"./vendor.52034c81.js";const X=228,N=80,re=68,le=13,T=16;const ue={name:"MessageShow",components:{WPlate:F},props:{messagePayload:{type:Object,required:!0},noDrawing:{type:Boolean,required:!1,default:!1},stripe:{type:Number,required:!1,default:null},autoRevoke:{type:Boolean,required:!1,default:!1}},created(){this.colorsHexL3=j},unmounted(){this.autoRevoke&&this.messagePayload.url&&URL.revokeObjectURL(this.messagePayload.url)},computed:{isMessageOneSegment:function(){return this.messagePayload.height<=T},getViewStyle:function(){return{width:`calc(${this.messagePayload.width}px * var(--global-ss))`,height:`calc(${this.messagePayload.height}px * var(--global-ss))`,backgroundImage:`url(${this.messagePayload.url})`}}},methods:{getUserTagSize:function(){const e=this.$refs["user-tag"].$el;return{width:e.offsetWidth,height:e.offsetHeight}}}};function he(e,t,s,n,u,o){const i=p("w-plate");return m(),k(i,{class:"message-area","tile-name":"main-drawing-area",notch:[!0,!0,!0,!0],"color-index":s.messagePayload.colorIndex,"stripe-mode":s.stripe},{default:x(()=>[se(e.$slots,"default",{},void 0,!0),s.noDrawing?q("",!0):(m(),C("div",{key:0,class:"drawing-area drawing-area-show pixel-rendering",style:y(o.getViewStyle)},null,4)),g(i,{class:_([o.isMessageOneSegment&&"fill","message-area-user-tag"]),"tile-name":"main-color-background","color-index":s.messagePayload.colorIndex,notch:[!0,!1,!0,o.isMessageOneSegment],ref:"user-tag"},{default:x(()=>[d("div",{class:"text",style:y({color:e.colorsHexL3[s.messagePayload.colorIndex]})},E(s.messagePayload.user),5)]),_:1},8,["class","color-index","notch"])]),_:3},8,["color-index","stripe-mode"])}var W=$(ue,[["render",he],["__scopeId","data-v-068b1924"]]);const ce={name:"Notification",components:{WPlate:F},props:{notificationPayload:{type:Object,required:!0}},computed:{isGlobal:function(){return this.notificationPayload.color==="global"},getStyle:function(){const e={};return this.isGlobal?(e.color="var(--global-cl2)",this.$global.rgbMode&&(e.filter=`hue-rotate(${this.$global.rgbColorHueDeg}deg)`)):e.color=this.notificationPayload.color?this.notificationPayload.color:"gray",e}}};function de(e,t,s,n,u,o){const i=p("w-plate");return m(),k(i,{class:"notification","tile-name":"main-inverted",notch:[!0,!0,!0,!0]},{default:x(()=>[d("div",{style:y(o.getStyle),class:_(["text",o.isGlobal&&e.$global.rgbMode&&"global-rgb"])},[D(E(s.notificationPayload.text)+" ",1),s.notificationPayload.textB!=null?(m(),C("span",{key:0,style:y({color:s.notificationPayload.colorB})},E(s.notificationPayload.textB),5)):q("",!0)],6)]),_:1})}var fe=$(ce,[["render",de],["__scopeId","data-v-3b4c932e"]]);const ge={name:"MiniEntry",props:{entry:{type:Object,required:!0}},computed:{isGlobal:function(){return this.entry.payload.color==="global"},getStyle:function(){const e={};if(this.entry.type==="message")this.entry.visible?e.backgroundColor=G[this.entry.payload.colorIndex]:e.backgroundColor=V[this.entry.payload.colorIndex];else if(this.entry.type==="notification")this.entry.visible?this.isGlobal?(e.backgroundColor="var(--global-cl2)",this.$global.rgbMode&&(e.filter=`hue-rotate(${this.$global.rgbColorHueDeg}deg)`)):e.backgroundColor="#606060":e.backgroundColor="#D1D1D1";else throw new Error("unknown entry type: "+this.entry.type);return e}}};function me(e,t,s,n,u,o){return m(),C("div",{class:_(["mini-entry",o.isGlobal&&e.$global.rgbMode&&"global-rgb"]),style:y(o.getStyle)},null,6)}var be=$(ge,[["render",me],["__scopeId","data-v-81984192"]]);const pe={name:"ChatQueue",components:{MiniEntry:be,Notification:fe,MessageShow:W},props:{attachMiniQueue:{type:String,required:!1,default:null}},data:function(){return{queue:[],mounted:!1}},computed:{},created(){this.selectedEntryIndex=this.queue.length-1,this.maxQueueLength=this.$global.chatQueueLimit},mounted:function(){this.addEntry({type:"notification",payload:{text:"Welcome to PICTOCLONE \u2638"}}),this.scrollToEntryDebounced=A.exports.debounce(this.scrollToEntry,150,{maxWait:333}),this.onScrollThrottled=A.exports.throttle(this.onScroll,133,{leading:!0,trailing:!0}),this.visibility={},this.pointerX=null,this.pointerY=null,this.mounted=!0},beforeUnmount:function(){this.mounted=!1,this.scrollToEntryDebounced.cancel(),this.scrollToEntryDebounced=void 0,this.onScrollThrottled.cancel(),this.onScrollThrottled=void 0},methods:{addEntry:function(e){e.visible=!1,e.size=-1;const t=this.selectedEntryIndex===this.queue.length-1,s=this.selectedEntryIndex===0;let n=!1;this.queue.push(e),this.queue.length>this.maxQueueLength&&(this.queue.shift(),n=!0),t?this.selectedEntryIndex=this.queue.length-1:!s&&n&&(this.selectedEntryIndex-=1),this.$nextTick(()=>{const u=this.$refs.queue.children;e.size=u[u.length-1].clientHeight,this.scrollToEntryDebounced(this.selectedEntryIndex)})},getEntryRangeSize:function(e,t){let s=0;for(let n=e;n<=t;++n)s+=this.queue[n].size;return s},scrollToEntry:function(e){const t=this.getEntryRangeSize(e+1,this.queue.length-1);this.$refs.queue.scrollTo({top:this.$refs.queue.scrollHeight-this.$refs.queue.clientHeight-t,left:0,behavior:"smooth"}),this.selectedEntryIndex=e},getVisibleEntries:function(e){const t=e.scrollHeight-(e.clientHeight+e.scrollTop),s=e.scrollHeight-e.scrollTop;let n=0,u=t,o=null,i=0,l=this.queue.length-1;for(;l>0;--l)if(n+=this.queue[l].size,n>u)if(o==null)o=l,u=s;else{i=l;break}o==null&&(o=0);for(let r=0;r<this.queue.length;++r)this.queue[r].visible=r>=i&&r<=o;return{bottomIndex:o,topIndex:i,total:o-i+1}},getSelectedMessage:function(){const e=this.queue[this.selectedEntryIndex];return e&&e.type==="message"?e.payload:null},onScrollUp:function(){this.selectedEntryIndex<=0?this.$global.audio.playProgram("pc-deny"):(this.$global.audio.playProgram("pc-scroll"),this.selectedEntryIndex-=1),this.scrollToEntryDebounced(this.selectedEntryIndex)},onScrollDown:function(){if(this.selectedEntryIndex>=this.queue.length-1){const e=performance.now();(this.previousScrollTime==null||e-this.previousScrollTime>125)&&(this.$global.audio.playProgram("pc-deny"),this.previousScrollTime=e)}else this.$global.audio.playProgram("pc-scroll"),this.selectedEntryIndex+=1;this.scrollToEntryDebounced(this.selectedEntryIndex)},onScroll:function(e){const t=e.target;this.visibility=this.getVisibleEntries(t)},onPointerDown:function(e){e.buttons&1&&(this.$refs.queue.setPointerCapture(e.pointerId),this.pointerX=e.clientX,this.pointerY=e.clientY)},onPointerMove:function(e){this.pointerX!=null&&requestAnimationFrame(()=>{if(this.pointerX!=null){const t=e.clientY-this.pointerY;this.$refs.queue.scrollBy({top:t*-2,left:0,behavior:"instant"}),this.pointerX=e.clientX,this.pointerY=e.clientY}})},onPointerUp:function(e){this.pointerX&&(this.scrollToEntryDebounced(this.visibility.bottomIndex),this.$refs.queue.releasePointerCapture(e.pointerId)),this.pointerX=null,this.pointerY=null},onPointerCancel:function(e){this.pointerX&&(this.scrollToEntryDebounced(this.visibility.bottomIndex),this.$refs.queue.releasePointerCapture(e.pointerId)),this.pointerX=null,this.pointerY=null},onWheel:function(e){e.deltaY>0?this.onScrollDown():e.deltaY<0&&this.onScrollUp()}}},ye={class:"queue-spacer",ref:"spacer"};function we(e,t,s,n,u,o){const i=p("notification"),l=p("message-show"),r=p("mini-entry");return m(),C("div",{class:"queue",ref:"queue",onScroll:t[0]||(t[0]=(...a)=>e.onScrollThrottled&&e.onScrollThrottled(...a)),onWheel:t[1]||(t[1]=(...a)=>o.onWheel&&o.onWheel(...a)),onPointerdown:t[2]||(t[2]=(...a)=>o.onPointerDown&&o.onPointerDown(...a)),onPointerup:t[3]||(t[3]=(...a)=>o.onPointerUp&&o.onPointerUp(...a)),onPointermove:t[4]||(t[4]=(...a)=>o.onPointerMove&&o.onPointerMove(...a)),onPointercancel:t[5]||(t[5]=(...a)=>o.onPointerCancel&&o.onPointerCancel(...a))},[d("div",ye,null,512),(m(!0),C(H,null,U(e.queue,(a,c)=>(m(),C("div",{key:c},[a.type==="notification"?(m(),k(i,{key:0,"notification-payload":a.payload},null,8,["notification-payload"])):a.type==="message"?(m(),k(l,{key:1,"message-payload":a.payload},null,8,["message-payload"])):q("",!0)]))),128)),e.mounted&&s.attachMiniQueue?(m(),k(Y,{key:0,to:s.attachMiniQueue},[(m(!0),C(H,null,U(e.queue,(a,c)=>(m(),k(r,{key:c,entry:a},null,8,["entry"]))),128))],8,["to"])):q("",!0)],544)}var xe=$(pe,[["render",we],["__scopeId","data-v-079a2075"]]);const ve="brush-normal",Ce=["brush-normal-1px","brush-normal-2px","brush-normal-5px"],Be={name:"WDrawingCanvas",emits:["text-buffer-line-break-aborted","stroke-start","stroke-move","stroke-end","flood-start","flood-move","flood-end"],props:{width:{type:Number,required:!0},height:{type:Number,required:!0},targetWidth:{type:Number,required:!0},targetHeight:{type:Number,required:!0},tool:{type:String,required:!1,default:"eraser"},brushSize:{type:Number,required:!1,default:2},toolColor:{type:String,required:!1,default:"#000"},textFont:{type:String,required:!1,default:null},lineHeight:{type:Number,required:!1,default:10},newLineXOffset:{type:Number,required:!1,default:4},rainbowBrush:{type:Boolean,required:!1,default:!1}},data:function(){return{beginPosition:{x:0,y:0},textBuffer:[]}},computed:{brush:function(){return this.brushType+"-"+this.brushSize+"px"},canvasStyle:function(){return{width:this.targetWidth+"px",height:this.targetHeight+"px"}},textBufferLastLine:{get:function(){return this.textBuffer[this.textBuffer.length-1]},set:function(e){this.textBuffer[this.textBuffer.length-1]+=e}},textBufferLastLineY:function(){return this.textY+this.lineHeight*(this.textBuffer.length-1)}},created:function(){this.brushType=ve,this.brushes=Ce,this.rainbowBrushColors=K,this.rainbowBrushColorIndex=0,this.painting=!1,this.stroking=!1,this.textBufferLineOffsets=[],this.textX=0,this.textY=0,this.brushesImages=this.generateBrushesImages()},mounted:function(){this.canvasContext=this.$refs.canvas.getContext("2d"),this.canvasBufferContext=this.$refs["canvas-buffer"].getContext("2d"),this.canvasBufferContext.font=this.textFont,this.canvasBuffer2Context=this.$refs["canvas-buffer2"].getContext("2d"),this.textBufferClear()},methods:{pointerDown:function(e){e.buttons&1&&(this.$refs.canvas.setPointerCapture(e.pointerId),this.tool==="flood"?this.floodFill(Math.round(e.offsetX/this.$global.superSample),Math.round(e.offsetY/this.$global.superSample)):this.startStroke(e.offsetX/this.$global.superSample,e.offsetY/this.$global.superSample))},pointerMove:function(e){this.moveStroke(e.offsetX/this.$global.superSample,e.offsetY/this.$global.superSample)},pointerUp:function(e){this.$refs.canvas.releasePointerCapture(e.pointerId),this.tool!=="flood"&&this.endStroke(e.offsetX/this.$global.superSample,e.offsetY/this.$global.superSample),this.controlAudioProgram&&(this.controlAudioProgram.stop(),this.controlAudioProgram=void 0)},pointerCancel:function(e){this.$refs.canvas.releasePointerCapture(e.pointerId),this.endStroke(e.offsetX/this.$global.superSample,e.offsetY/this.$global.superSample)},startStroke:function(e,t){this.painting=!0,this.stroking=!1,this.canvasContext.lineWidth=this.brushSize,this.tool==="eraser"?this.canvasContext.globalCompositeOperation="destination-out":this.canvasContext.globalCompositeOperation="source-over",this.strokePreviousTimestamp=void 0,this.beginPosition={x:Math.round(e),y:Math.round(t)},this.$emit("stroke-start",this.tool)},moveStroke:function(e,t){this.painting&&requestAnimationFrame(s=>{if(this.painting&&(this.strokePreviousTimestamp==null||s-this.strokePreviousTimestamp>16)){this.stroking=!0;const n={x:Math.round(e),y:Math.round(t)},u=Math.min(this.distanceBetween(this.beginPosition,n),100),o=this.angleBetween(this.beginPosition,n),i=Math.floor(this.brushSize/2),l=this.brushSize>=2?Math.floor(u):Math.ceil(u);let r;this.rainbowBrush?(this.rainbowBrushColorIndex+=1,this.rainbowBrushColorIndex>this.rainbowBrushColors.length-1&&(this.rainbowBrushColorIndex=0),this.canvasBuffer2Context.globalCompositeOperation="source-over",this.canvasBuffer2Context.clearRect(0,0,this.width,this.height),r=this.canvasBuffer2Context):r=this.canvasContext;for(let a=0;a<l;a++){const c=this.beginPosition.x+Math.sin(o)*a-i,h=this.beginPosition.y+Math.cos(o)*a-i;r.drawImage(this.brushesImages[this.brush],Math.round(c),Math.round(h))}this.rainbowBrush&&(this.canvasBuffer2Context.globalCompositeOperation="source-in",this.canvasBuffer2Context.fillStyle=this.rainbowBrushColors[this.rainbowBrushColorIndex],this.canvasBuffer2Context.fillRect(0,0,this.width,this.height),this.canvasContext.drawImage(this.$refs["canvas-buffer2"],0,0)),this.beginPosition=n,this.$emit("stroke-move",u),this.strokePreviousTimestamp=s}})},endStroke:function(e,t){this.stroking?this.rainbowBrush&&this.canvasBuffer2Context.clearRect(0,0,this.width,this.height):this.canvasContext.drawImage(this.brushesImages[this.brush],this.beginPosition.x,this.beginPosition.y),this.$emit("stroke-end"),this.painting=!1,this.stroking=!1},floodFill:async function(e,t){if(this.flooding)return;this.flooding=!0,this.$emit("flood-start");const s=this.canvasContext.getImageData(0,0,this.width,this.height);this.rainbowBrushColorIndex=Math.round((this.rainbowBrushColors.length-1)*Math.random());let n=0,u=0,o=0;if(this.rainbowBrush){const c=z(this.rainbowBrushColors[this.rainbowBrushColorIndex]);n=c.r,u=c.g,o=c.b}const{data:i,height:l,width:r}=s,a=t*r*4+e*4;i[a]=n,i[a+1]=u,i[a+2]=o,i[a+3]=255,await this.interactiveFloodFill(s,e,t,n,u,o),this.$emit("flood-end"),this.flooding=!1},imageDataComparePixels(e,t,s,n,u){const{data:o,height:i,width:l}=e;if(s<0||s>i-1||u<0||u>i-1||t<0||t>l-1||n<0||n>l-1)return-1;const r=s*l*4+t*4,a=o[r],c=o[r+1],h=o[r+2],f=o[r+3],b=u*l*4+n*4,I=o[b],B=o[b+1],P=o[b+2],S=o[b+3];return a===I&&c===B&&h===P&&f===S?b:-1},imageDataCompareRGBAToPixel(e,t,s,n,u,o,i){const{data:l,height:r,width:a}=e;if(i<0||i>r-1||o<0||o>a-1)return-1;const c=i*a*4+o*4,h=l[c],f=l[c+1],b=l[c+2],I=l[c+3];return t===h&&s===f&&n===b&&u===I?c:-1},floodFillHorizontal:async function(e,t,s,n,u=!0,o=!0){n+=1,n>this.maxDepth&&(this.maxDepth=n);const i=[],l=[],{data:r,height:a,width:c}=e;if(u)for(let h=t;h>0;--h){const f=this.imageDataCompareRGBAToPixel(e,0,0,0,0,h-1,s);if(f>=0)r[f]=0,r[f+1]=0,r[f+2]=0,r[f+3]=255,i.push(h-1,s+1,h-1,s-1),l.push(h-1,s+1,h-1,s-1);else break}if(o)for(let h=t;h<c;++h){const f=this.imageDataCompareRGBAToPixel(e,0,0,0,0,h+1,s);if(f>=0)r[f]=0,r[f+1]=0,r[f+2]=0,r[f+3]=255,i.push(h+1,s+1,h+1,s-1),l.push(h+1,s+1,h+1,s-1);else break}for(let h=0;h<i.length;h+=4)await this.floodFillHorizontal(e,i[h],i[h+1],n,!0,!1),await this.floodFillHorizontal(e,i[h+2],i[h+3],n,!0,!1);for(let h=0;h<l.length;h+=4)await this.floodFillHorizontal(e,i[h],i[h+1],n,!1,!0),await this.floodFillHorizontal(e,i[h+2],i[h+3],n,!1,!0);this.canvasContext.putImageData(e,0,0),await new Promise(requestAnimationFrame)},interactiveFloodFill:async function(e,t,s,n,u,o){const{data:i,height:l,width:r}=e,a=[s,[t]];let c=0,h=0,f=2,b=0,I=0;for(;a.length>0;){const B=a.pop(),P=a.pop(),S=[];for(let v=0;v<B.length;++v){let O=B[v],w;const R=P;let M=O;for(;(w=this.imageDataCompareRGBAToPixel(e,0,0,0,0,M-1,R))&&w>=0;)i[w]=n,i[w+1]=u,i[w+2]=o,i[w+3]=255,S.push(M),M-=1;for(M=O;(w=this.imageDataCompareRGBAToPixel(e,0,0,0,0,M+1,R))&&w>=0;)i[w]=n,i[w+1]=u,i[w+2]=o,i[w+3]=255,S.push(M),M+=1}if(S.length>0&&(P<l-1&&a.push(P+1,S),P>0&&a.push(P-1,S)),h%f==0||a.length<=0){if(this.canvasContext.putImageData(e,0,0),h>1e3)f=8;else if(h>1e4)f=64;else if(h>2e5)break;if(b+=B.length,this.rainbowBrush&&b>r*2){b=0;const v=z(this.rainbowBrushColors[this.rainbowBrushColorIndex]);n=v.r,u=v.g,o=v.b,this.rainbowBrushColorIndex+=1,this.rainbowBrushColorIndex>this.rainbowBrushColors.length-1&&(this.rainbowBrushColorIndex=0)}this.$emit("flood-move",{pixelsFilled:B.length===I?Math.round(Math.random()*r):B.length,width:r}),I=B.length;do{const v=await new Promise(requestAnimationFrame);if(v-c>16){c=v;break}}while(!0)}h+=1}},distanceBetween:function(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},angleBetween:function(e,t){return Math.atan2(t.x-e.x,t.y-e.y)},clear:function(){this.canvasContext.clearRect(0,0,this.width,this.height),this.textBufferClear()},elementOffset:function(e){const t=e.getBoundingClientRect(),s=window.pageXOffset||document.documentElement.scrollLeft,n=window.pageYOffset||document.documentElement.scrollTop;return{top:t.top+n,left:t.left+s,right:t.right+s,bottom:t.bottom+n}},getCanvasGlobalPosition:function(){const e=this.elementOffset(this.$refs.canvas),t=e.right-e.left,s=e.bottom-e.top;return{...e,widthProportion:this.width/t,heightProportion:this.height/s}},textBufferSetStart:function(e,t){this.textX=e,this.textY=t},textBufferClear:function(){this.canvasBufferContext.clearRect(0,0,this.width,this.height),this.textBuffer=[],this.textBufferLineOffsets=[]},textBufferLinebreak:function(){return this.textBufferLastLineY+this.lineHeight>this.height?(this.$emit("text-buffer-line-break-aborted"),!1):(this.textBuffer.push(""),this.textBufferLineOffsets.push(this.newLineXOffset),!0)},textBufferBackspace:function(){let e;this.textBufferLastLine&&(e=this.textBufferLastLine.substring(0,this.textBufferLastLine.length-1)),e==null||e===""?(this.textBuffer.pop(),this.textBufferLineOffsets.pop()):this.textBuffer[this.textBuffer.length-1]=e,this.redrawTextBuffer()},textBufferAppend:function(e){this.textBuffer.length<=0&&(this.textBuffer.push(""),this.textBufferLineOffsets.push(this.textX));const t=this.canvasBufferContext.measureText(this.textBufferLastLine+e);this.textBufferLineOffsets[this.textBufferLineOffsets.length-1]+Math.round(t.width)>=this.width&&!this.textBufferLinebreak()||(this.textBufferLastLine=e,this.redrawTextBuffer())},textBufferSwapChar:function(e){this.textBuffer[this.textBuffer.length-1]=this.textBufferLastLine.substring(0,this.textBufferLastLine.length-1)+e,this.redrawTextBuffer()},redrawTextBuffer:function(){this.canvasBufferContext.clearRect(0,0,this.width,this.height);let e=this.textY;for(let t=0;t<this.textBuffer.length;++t){const s=this.textBuffer[t],n=this.textBufferLineOffsets[t];this.canvasBufferContext.fillText(s,n,e),e+=this.lineHeight}},textBufferMerge:function(){this.canvasContext.globalCompositeOperation="source-over",this.canvasContext.drawImage(this.$refs["canvas-buffer"],0,0),this.textBufferClear()},getImageBounds:function(){const e=this.canvasContext.getImageData(0,0,this.width,this.height),{data:t,height:s,width:n}=e;let u,o=s,i=0,l=n,r=0;for(let a=0;a<s;++a)for(let c=0;c<n;++c)u=a*n*4+c*4,t[u+3]&&(o=a<o?a:o,i=a>i?a:i,l=c<l?c:l,r=c>r?c:r);return o=o<i?o:0,i=i>o?i:0,l=l<r?l:0,r=r<l?r:0,{boundsTop:o,boundsBottom:i,boundsLeft:l,boundsRight:r,boundsWidth:r-l,boundsHeight:i-o,imageWidth:n,imageHeight:s}},getImage:async function(e){const t={};let s;if(e){const u=document.createElement("canvas");if(u.getContext){const o=u.getContext("2d"),i=e.right-e.left,l=e.bottom-e.top;u.width=i,u.height=l,o.globalCompositeOperation="copy",o.imageSmoothingEnabled=!1,o.drawImage(this.$refs.canvas,e.left,e.top,i,l,0,0,i,l),s=u,t.width=i,t.height=l}else throw new Error("Could not create canvas for cropping")}else s=this.$refs.canvas,t.width=this.width,t.height=this.height;const n=await Q(s);return e&&s.remove(),{url:URL.createObjectURL(n),blob:n,...t}},drawFromImageUrl:function(e){const t=new Image;t.src=e,t.onload=()=>{this.canvasContext.drawImage(t,0,0)}},generateBrushesImages:function(){const e={};return this.brushes.forEach(t=>{const s=new Image;s.src=this.$tileMap(t).url,e[t]=s}),e}}},ke=["width","height"],_e=["width","height"],Pe=["width","height"];function Se(e,t,s,n,u,o){return m(),C("div",ie({class:"canvas-wrapper"},e.$attrs),[d("canvas",{ref:"canvas-buffer2",width:s.width,height:s.height,class:"canvas canvas-buffer2 pixel-rendering",style:y(o.canvasStyle)},null,12,ke),d("canvas",{ref:"canvas-buffer",width:s.width,height:s.height,class:"canvas canvas-buffer pixel-rendering",style:y(o.canvasStyle)},null,12,_e),d("canvas",{ref:"canvas",width:s.width,height:s.height,class:"canvas pixel-rendering",style:y(o.canvasStyle),onPointerdown:t[0]||(t[0]=(...i)=>o.pointerDown&&o.pointerDown(...i)),onPointermove:t[1]||(t[1]=(...i)=>o.pointerMove&&o.pointerMove(...i)),onPointerup:t[2]||(t[2]=(...i)=>o.pointerUp&&o.pointerUp(...i)),onPointercancel:t[3]||(t[3]=(...i)=>o.pointerCancel&&o.pointerCancel(...i))},null,44,Pe)],16)}var Me=$(Be,[["render",Se],["__scopeId","data-v-79cc4937"]]);const $e={name:"MessageDraw",components:{MessageShow:W,WDrawingCanvas:Me},emits:["fun"],props:{selectedTool:{type:String,required:!1,default:null},brushSize:{type:Number,required:!1,default:null},messagePayload:{type:Object,required:!1,default:()=>{}},rainbowBrush:{type:Boolean,required:!1,defaults:!1}},created(){const e={enter:()=>this.keyPressEnter(),"small-enter":()=>this.keyPressEnter(),backspace:()=>this.keyPressBackspace(),"small-backspace":()=>this.keyPressBackspace(),space:()=>this.keyPress(" "),"small-space":()=>this.keyPress(" "),shift:()=>{},caps:()=>{},hiragana:()=>{},katakana:()=>{},komoji:()=>{}};this.defaultTextX=re,this.defaultTextY=le,this.specialKeys=e,this.secretMessage="i want fun",this.secretMessageCheckIndex=0,this.controlAudioProgramBrush=void 0},mounted:function(){setTimeout(()=>{this.defaultTextX=this.$refs.message.getUserTagSize().width/this.$global.superSample,this.$refs.drawing.textBufferSetStart(this.defaultTextX,this.defaultTextY)},66)},beforeUnmount(){this.rainbowBrush&&this.$global.setRgbMode(!1)},computed:{targetWidth:function(){return this.messagePayload.width*this.$global.superSample},targetHeight:function(){return this.messagePayload.height*this.$global.superSample}},methods:{clearDrawing:function(){!this.$refs.drawing||(this.$refs.drawing.clear(),this.$refs.drawing.textBufferSetStart(this.defaultTextX,this.defaultTextY))},textMerge:function(){this.$refs.drawing.textBufferMerge(),this.$refs.drawing.textBufferSetStart(this.defaultTextX,this.defaultTextY)},getMessage:async function(){this.textMerge();const e=this.$refs.drawing.getImageBounds();if(e.boundsTop===e.boundsBottom)throw new Error("empty");e.boundsTop=Math.floor(e.boundsTop/T)*T,e.boundsBottom=Math.ceil((e.boundsBottom+1)/T)*T,e.boundsLeft=0,e.boundsRight=e.imageWidth,e.boundsTop>=T&&(e.boundsTop=e.boundsTop-T);const t=await this.$refs.drawing.getImage({top:e.boundsTop,bottom:e.boundsBottom,left:e.boundsLeft,right:e.boundsRight});return{...this.messagePayload,...t}},pasteFromMessage:function(e){this.$refs.drawing.clear(),this.$refs.drawing.drawFromImageUrl(e.url)},keyPress:function(e){!this.$refs.drawing||(this.specialKeys[e]?this.specialKeys[e](e):(this.secretMessageCheck(e),this.$refs.drawing.textBufferAppend(e)))},swapChar:function(e){this.$refs.drawing.textBufferSwapChar(e)},keyPressEnter:function(){!this.$refs.drawing||this.$refs.drawing.textBufferLinebreak()},keyPressBackspace:function(){!this.$refs.drawing||this.$refs.drawing.textBufferBackspace()},secretMessageCheck:function(e){this.rainbowBrush||(e===this.secretMessage[this.secretMessageCheckIndex]?this.secretMessageCheckIndex+=1:e===this.secretMessage[0]?this.secretMessageCheckIndex=1:this.secretMessageCheckIndex=0,this.secretMessageCheckIndex>=this.secretMessage.length&&this.$emit("fun"))},symbolDrop:function(e){if(!this.$refs.drawing)return;const t=this.$refs.drawing.getCanvasGlobalPosition(),s=e.event.pageX,n=e.event.pageY;s>t.left&&s<t.right-5&&n>t.top&&n<t.bottom-12&&(this.$global.audio.playProgram("pc-symboldrop"),this.$refs.drawing.textBufferMerge(),this.$refs.drawing.textBufferSetStart(Math.round((s-t.left)*t.widthProportion)-3,Math.round((n-t.top)*t.heightProportion)+5),this.$refs.drawing.textBufferAppend(e.symbol))},strokeStart:function(e){this.controlAudioProgramBrush||(this.controlAudioProgramBrush=this.$global.audio.startComplexProgram(e==="eraser"?"pc-eraser-cp":"pc-pen-cp"))},strokeMove:function(e){this.controlAudioProgramBrush&&this.controlAudioProgramBrush.modify(e,.3)},strokeEnd:function(){this.controlAudioProgramBrush&&(this.controlAudioProgramBrush.stop(),this.controlAudioProgramBrush=void 0)},floodStart:function(){this.controlAudioProgramFlood||(this.controlAudioProgramFlood=this.$global.audio.startComplexProgram("pc-flood-cp"),this.controlAudioProgramFlood2=this.$global.audio.startComplexProgram("pc-flood2-cp"))},floodMove:function(e){this.controlAudioProgramFlood&&(this.controlAudioProgramFlood.modify(e.pixelsFilled,e.width),this.controlAudioProgramFlood2.modify(e.pixelsFilled,e.width))},floodEnd:function(){this.controlAudioProgramFlood&&(this.controlAudioProgramFlood.stop(),this.controlAudioProgramFlood=void 0,this.controlAudioProgramFlood2.stop(),this.controlAudioProgramFlood2=void 0)}}};function Te(e,t,s,n,u,o){const i=p("w-drawing-canvas"),l=p("message-show");return m(),k(l,{"message-payload":s.messagePayload,"no-drawing":!0,stripe:2,ref:"message"},{default:x(()=>[g(i,{width:s.messagePayload.width,height:s.messagePayload.height,ref:"drawing",class:"drawing-area","target-width":o.targetWidth,"target-height":o.targetHeight,"rainbow-brush":s.rainbowBrush,tool:s.selectedTool,"brush-size":s.brushSize,"text-font":"10px NDS12","line-height":16,onStrokeStart:o.strokeStart,onStrokeMove:o.strokeMove,onStrokeEnd:o.strokeEnd,onFloodStart:o.floodStart,onFloodMove:o.floodMove,onFloodEnd:o.floodEnd},null,8,["width","height","target-width","target-height","rainbow-brush","tool","brush-size","onStrokeStart","onStrokeMove","onStrokeEnd","onFloodStart","onFloodMove","onFloodEnd"])]),_:1},8,["message-payload"])}var Ie=$($e,[["render",Te],["__scopeId","data-v-0833c75e"]]);const qe={"brush-bigger":5,"brush-big":2,"brush-small":1},Ee={name:"Chat",components:{ModalDialog:J,MessageDraw:Ie,ChatQueue:xe,Keyboard:Z,WButtonToggle:ee,WPlate:F,WButton:te},props:{roomCode:{type:String,required:!1,default:null}},data:function(){return{keyboardMode:"romaji",selectedTool:"brush",brushSize:"brush-big",messagePayload:{user:this.$global.userName,colorIndex:this.$global.userColorIndex,width:X,height:N},mounted:!1,fun:!1,rainbowBrush:!1,modal:!1,modalText:"",modalButtonText:"Ok",modalCallback:null}},created(){this.brushSizes=qe,this.toolClickCallbacks=[()=>{this.$global.audio.playProgram("pc-flood")},()=>{this.$global.audio.playProgram("pc-pen")},()=>{this.$global.audio.playProgram("pc-eraser")}],this.sizeClickCallbacks=[()=>{this.$global.audio.playProgram("pc-brushbigger")},()=>{this.$global.audio.playProgram("pc-brushbig")},()=>{this.$global.audio.playProgram("pc-brushsmall")}];const e=()=>{this.$global.audio.playProgram("pc-click")};this.keyboardModeClickCallbacks=[e,e,e,e,e]},mounted:function(){this.roomCode!=null&&this.roomCode!==""&&this.roomCode!==this.$global.roomCode&&(this.$global.roomCode=this.roomCode),this.mounted=!0,this.connect()},beforeUnmount:function(){this.mounted=!1;const e=this.$global.chatClient;e.connected&&e.sendLeaveRoom(),document.fullscreenElement&&document.exitFullscreen&&document.exitFullscreen()},computed:{rgbStyle:function(){const e={};return this.$global.rgbMode&&(e.filter=`hue-rotate(${this.$global.rgbColorHueDeg}deg)`),e}},methods:{connect:async function(){try{const e=this.$global.chatClient;if(e.connected||await e.startConnection(this.$global.serverAddress),!e.roomConnected){const t=await e.sendConnectRoom(Number(this.roomCode),this.$global.userName,this.$global.userColorIndex)}this.restoreChatHandlers(),this.$refs.queue.addEntry({type:"notification",payload:{text:"Connected to room: ",textB:Number(this.roomCode).toLocaleString("pt-BR"),color:"#e2f201",colorB:"#EEE"}})}catch(e){this.modal=!0,this.modalText=e.message,this.modalButtonText="Leave",this.modalCallback=this.onClose}},restoreChatHandlers:function(){const e=this.$global.chatClient;e.onOpenCallback=()=>{},e.onCloseCallback=()=>{this.modal=!0,this.modalText="Connection closed unexpectedly",this.modalButtonText="Leave",this.modalCallback=this.onClose},e.onReceiveChatMessages=this.handleReceiveChatMessages,e.onUserListChange=this.handleUserListChange},handleKeyPress:function(e){this.$refs["user-message"].keyPress(e)},handleSwapChar:function(e){this.$refs["user-message"].swapChar(e)},handleSymbolDrag:function(e){this.$refs["user-message"].symbolDrop(e)},onScrollUp:function(){this.$refs.queue.onScrollUp()},onScrollDown:function(){this.$refs.queue.onScrollDown()},copySelectedMessage:function(){const e=this.$refs.queue.getSelectedMessage();e&&(this.$global.audio.playProgram("pc-copy"),this.$refs["user-message"].pasteFromMessage(e))},handleReceiveChatMessages:function(e){for(let t=0;t<e.length;++t){const s=e[t],n=oe(s.image);if(n==null){console.warn("discarding malformed message");continue}if(n.width>X||n>N){console.warn("discarding malformed message");continue}const u=new Blob([s.image],{type:"image/png"}),o={type:"message",payload:{user:s.userName,colorIndex:s.colorIndex,width:n.width,height:n.height,url:URL.createObjectURL(u)}};this.$refs.queue.addEntry(o)}this.$global.audio.playProgram("pc-receive")},mapUserList:function(e){return new Map(e.map(t=>[t.publicId,t]))},handleUserListChange:function(e,t){const s=this.mapUserList(t),n=this.mapUserList(e),u=new Map([...s,...n]);for(let[o,i]of u){const l=s.has(o),r=n.has(o);if(l&&!r){const a=s.get(o);this.$global.audio.playProgram("pc-bells"),this.$refs.queue.addEntry({type:"notification",payload:{text:"Now entering: ",textB:a.userName,color:"#e2f201",colorB:"#EEE"}})}else if(!l&&r){const a=n.get(o);this.$refs.queue.addEntry({type:"notification",payload:{text:"Now leaving: ",textB:a.userName,color:"#e2f201",colorB:"#EEE"}})}}t.length<=1&&setTimeout(()=>{this?.$refs?.queue.addEntry({type:"notification",payload:{text:"You are now all alone... REMINDER: room will close once it's empty",color:"#e2f201"}})},1e3)},sendMessage:async function(){let e;try{e=await this.$refs["user-message"].getMessage();const t=await e.blob.arrayBuffer();await this.$global.chatClient.sendChatMessage({text:"",image:t,timestamp:Date.now()}),e.blob=void 0,this.$refs["user-message"].clearDrawing(),this.$global.audio.playProgram("pc-send");const s={type:"message",payload:e};this.$refs.queue.addEntry(s)}catch{this.$global.audio.playProgram("pc-deny"),e&&e.url&&URL.revokeObjectURL(e.url)}},clearDrawing:function(){this.$global.audio.playProgram("pc-clear"),this.$refs["user-message"].clearDrawing()},onClose:function(){this.modal=!1,this.$router.replace({name:"Home",query:{v:"lobby"}})},onFun:function(){this.$refs.queue.addEntry({type:"notification",payload:{text:"You want fun?",color:"global"}}),setTimeout(()=>{this.$refs.queue.addEntry({type:"notification",payload:{text:"Wario gonna show you fun",color:"global"}}),this.rainbowBrush=!0,this.$global.setRgbMode(!0),this.fun=!0},1e3)},toggleRainbow:function(){const e=!this.$global.rgbMode;this.$global.setRgbMode(e),this.rainbowBrush=e},toggleFullscreen:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}},L=e=>(ne("data-v-7a81afa3"),e=e(),ae(),e),Le={class:"main"},Fe={class:"button-bar"},De=D(" \u2716 "),Oe=L(()=>d("span",{style:{"padding-left":"calc(0.5px * var(--global-ss))"}},"\u2195",-1)),Re=L(()=>d("div",{class:"mini-queue-wrapper"},[d("div",{id:"mini-queue",class:"mini-queue"})],-1)),ze=L(()=>d("div",{class:"separator"},null,-1)),Ae={class:"button-bar-wrapper"},He=L(()=>d("div",{class:"separator landscape-hide"},null,-1)),Ue={class:"rainbow-button"},Ye={class:"main-wrapper"},Xe={class:"main-queue-container"},Ne={class:"button-bar portrait-hide"},We={class:"main-interface-container"},je={class:"main-interface-bottom"},Ve={class:"button-cluster"},Ge=L(()=>d("div",{class:"separator"},null,-1)),Ke={style:{color:"white"}};function Qe(e,t,s,n,u,o){const i=p("w-button"),l=p("chat-queue"),r=p("w-plate"),a=p("message-draw"),c=p("keyboard"),h=p("w-button-toggle"),f=p("modal-dialog");return m(),C("div",Le,[d("div",Fe,[d("div",{class:_(["button-bar-wrapper","global-color-hue-tint",e.$global.rgbMode&&"global-rgb"]),style:y(o.rgbStyle)},[g(i,{"plate-padding":0,class:"more-button","normal-tile":"beveled-button","active-tile":"beveled-button-highlight",onClick:o.onClose,"audio-feedback":""},{default:x(()=>[De]),_:1},8,["onClick"]),g(i,{"plate-padding":0,class:"more-button","normal-tile":"beveled-button","active-tile":"beveled-button-highlight",onClick:o.toggleFullscreen,"audio-feedback":""},{default:x(()=>[Oe]),_:1},8,["onClick"])],6),Re,ze,d("div",Ae,[g(i,{class:"closer",icon:"arrow-up","plate-padding":0,"normal-class":"simple-button-normal","active-class":"simple-button-active",onClick:o.onScrollUp},null,8,["onClick"]),g(i,{class:"closer",icon:"arrow-down","plate-padding":0,"normal-class":"simple-button-normal","active-class":"simple-button-active",onClick:o.onScrollDown},null,8,["onClick"])]),He,e.fun?(m(),C("div",{key:0,class:_(["button-bar-wrapper",[e.$global.rgbMode&&"global-rgb"]]),style:y(o.rgbStyle)},[g(i,{class:"rainbow-button",onClick:o.toggleRainbow,toggled:e.$global.rgbMode,"audio-feedback":""},{default:x(()=>[d("div",Ue,E(e.$global.rgbMode?"\u2638":"\u263A"),1)]),_:1},8,["onClick","toggled"])],6)):q("",!0),d("div",{ref:"buttons-mount-portrait",class:_([e.$global.rgbMode&&"global-rgb"]),style:y(o.rgbStyle)},null,6)]),d("div",Ye,[d("div",Xe,[g(r,{class:"main-queue-wrapper","tile-name":"main-background",notch:[!0,!0,!0,!0],padding:3,"stripe-mode":1,"stripe-color":"#bababa"},{default:x(()=>[g(l,{ref:"queue","attach-mini-queue":"#mini-queue"},null,512)]),_:1})]),d("div",Ne,[d("div",{ref:"buttons-mount-landscape",class:_([e.$global.rgbMode&&"global-rgb"]),style:y(o.rgbStyle)},null,6)]),d("div",We,[g(r,{class:"main-interface-wrapper","tile-name":"main-background",notch:[!0,!1,!1,!0],padding:3,"stripe-mode":1,"stripe-color":"#bababa"},{default:x(()=>[g(a,{"selected-tool":e.selectedTool,"brush-size":e.brushSizes[e.brushSize],"message-payload":e.messagePayload,ref:"user-message",class:"user-message","rainbow-brush":e.rainbowBrush,onFun:o.onFun},null,8,["selected-tool","brush-size","message-payload","rainbow-brush","onFun"]),d("div",je,[g(c,{class:_(["keyboard",[e.$global.rgbMode&&"global-rgb"]]),mode:e.keyboardMode,style:y(o.rgbStyle),onKeyboardKeyPress:o.handleKeyPress,onSymbolDrag:o.handleSymbolDrag,onKeyboardSwapChar:o.handleSwapChar},null,8,["mode","class","style","onKeyboardKeyPress","onSymbolDrag","onKeyboardSwapChar"]),d("div",Ve,[g(i,{class:"button-cluster-button",icon:"send","normal-tile":"main-button","active-tile":"main-color-fill","plate-notch":[!0,!1,!1,!1],"plate-padding":3,onClick:o.sendMessage},null,8,["onClick"]),g(i,{class:"button-cluster-button middle-button",icon:"copy","normal-tile":"main-button","active-tile":"main-color-fill","plate-padding":4,onClick:o.copySelectedMessage},null,8,["onClick"]),g(i,{class:"button-cluster-button",icon:"clear","normal-tile":"main-button","active-tile":"main-color-fill","plate-notch":[!1,!1,!1,!0],"plate-padding":4,onClick:o.clearDrawing},null,8,["onClick"])])])]),_:1})])]),e.mounted?(m(),k(Y,{key:0,to:e.$refs[e.$global.isLandscape?"buttons-mount-landscape":"buttons-mount-portrait"]},[g(h,{modelValue:e.selectedTool,"onUpdate:modelValue":t[0]||(t[0]=b=>e.selectedTool=b),class:"button-bar-wrapper","common-options":{class:"closer","normal-class":"simple-button-normal","active-class":"simple-button-active",iconMargin:[1,1]},"click-callbacks":e.toolClickCallbacks,options:[{icon:"bucket",name:"flood"},{icon:"brush",name:"brush"},{icon:"eraser",name:"eraser"}]},null,8,["modelValue","click-callbacks"]),g(h,{modelValue:e.brushSize,"onUpdate:modelValue":t[1]||(t[1]=b=>e.brushSize=b),class:"button-bar-wrapper","common-options":{class:"closer","normal-class":"simple-button-normal","active-class":"simple-button-active",iconMargin:[1,1]},"click-callbacks":e.sizeClickCallbacks,options:[{icon:"brush-bigger",name:"brush-bigger"},{icon:"brush-big",name:"brush-big"},{icon:"brush-small",name:"brush-small"}]},null,8,["modelValue","click-callbacks"]),Ge,g(h,{modelValue:e.keyboardMode,"onUpdate:modelValue":t[2]||(t[2]=b=>e.keyboardMode=b),class:"button-bar-wrapper","common-options":{class:"keyboard-buttons","plate-notch":[!0,!1,!1,!1],"normal-tile":"small-button","active-tile":"small-button-highlight","plate-padding":1},"click-callbacks":e.keyboardModeClickCallbacks,options:[{icon:"romaji",name:"romaji"},{icon:"accents",name:"accents"},{icon:"kana",name:"kana"},{icon:"symbols1",name:"symbols1"},{icon:"symbols2",name:"symbols2"}]},null,8,["modelValue","click-callbacks"])],8,["to"])):q("",!0),g(f,{show:e.modal,padding:16},{default:x(()=>[d("div",Ke,E(e.modalText),1),g(i,{"plate-padding":3,class:"dismiss-button","normal-tile":"large-beveled-button","active-tile":"large-beveled-button-inverted",onClick:e.modalCallback,"audio-feedback":""},{default:x(()=>[D(E(e.modalButtonText),1)]),_:1},8,["onClick"])]),_:1},8,["show"])])}var et=$(Ee,[["render",Qe],["__scopeId","data-v-7a81afa3"]]);export{et as default};
